var Ut=Object.defineProperty,Pt=Object.defineProperties;var Ct=Object.getOwnPropertyDescriptors;var ut=Object.getOwnPropertySymbols;var kt=Object.prototype.hasOwnProperty,Nt=Object.prototype.propertyIsEnumerable;var ct=(t,e,r)=>e in t?Ut(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,u=(t,e)=>{for(var r in e||(e={}))kt.call(e,r)&&ct(t,r,e[r]);if(ut)for(var r of ut(e))Nt.call(e,r)&&ct(t,r,e[r]);return t},y=(t,e)=>Pt(t,Ct(e));function Et(){let t=crypto;if(t!=null&&t.randomUUID)return t.randomUUID();throw new Error("Failed to generate a random UUID.")}function yt(t){if(typeof t!="string"||!/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i.test(t))throw new Error(`The entity id '${t}' is invalid.`)}function Mt(t){var r,i,s,c;function e(p){return p}return y(u({},t),{validateSchema:(r=t.validateSchema)!=null?r:e,generateEntityId:(i=t.generateEntityId)!=null?i:Et,validateEntityId:(s=t.validateEntityId)!=null?s:yt,entitiesExtensions:(c=t.entitiesExtensions)!=null?c:{}})}function G(t,e){return e.entities.find(r=>r.name===t)}function R(t,e){let r=G(t,e);if(!r)throw new Error(`Unkown entity type "${t}".`);return r}function K(t,e,r){let s=R(t,r).attributes.find(c=>c.name===e);if(!s)throw new Error(`Unkown entity attribute "${e}".`);return s}function F(t,e,r){return e.map(s=>K(t,s,r))}function J(t,e,r){var c,p;let i=R(t,r),s=(p=(c=r.entitiesExtensions[t])==null?void 0:c.childrenAllowed)!=null?p:i.childrenAllowed;return s?s===!0||s.includes(e):!1}function Q(t,e,r){var s;let i=(s=r.entitiesExtensions[t])==null?void 0:s.allowedParents;return!i||i.includes(e)}function pt(t,e){var i,s;let r=R(t,e);return(s=(i=e.entitiesExtensions[t])==null?void 0:i.parentRequired)!=null?s:r.parentRequired}function q(t,e,r){if(!J(t,e,r))throw new Error("Child is not allowed.")}function X(t,e,r){if(!Q(t,e,r))throw new Error("Parent is not allowed.")}function Y(t,e){var s,c;let r=R(t,e);if((c=(s=e.entitiesExtensions[t])==null?void 0:s.parentRequired)!=null?c:r.parentRequired)throw new Error("A parent is required.")}function Wt(t){var c,p,T,f,w,o,l;let e=[];function r(n){if(typeof n!="undefined")throw new Error(`Values for entities of type '${t.name}' are not allowed.`)}function i(){}function s(){return!0}return y(u({},t),{childrenAllowed:(c=t.childrenAllowed)!=null?c:!1,parentRequired:(p=t.parentRequired)!=null?p:!1,attributes:(T=t.attributes)!=null?T:e,valueAllowed:typeof t.validate=="function",attributesExtensions:(f=t.attributesExtensions)!=null?f:{},validate:(w=t.validate)!=null?w:r,defaultValue:(o=t.defaultValue)!=null?o:i,shouldBeProcessed:(l=t.shouldBeProcessed)!=null?l:s})}function Ot(t){return t}function ht(){let t=new Set;return{notify(e,r){t.forEach(i=>{i(e,r)})},subscribe(e){return t.add(e),()=>{t.delete(e)}}}}function z(t){let e=t;function r(){return e}let{notify:i,subscribe:s}=ht();return{subscribe:s,getData:r,setData(c,p){return e=c,i(e,p),e}}}var B={InvalidRootFormat:"InvalidRootFormat",DuplicateRootId:"DuplicateRootId",DuplicateChildId:"DuplicateChildId",RootEntityWithParent:"RootEntityWithParent",EmptyRoot:"EmptyRoot",NonexistentEntityId:"NonexistentEntityId",InvalidEntitiesFormat:"InvalidEntitiesFormat",MissingEntityType:"MissingEntityType",UnknownEntityType:"UnknownEntityType",InvalidChildrenFormat:"InvalidChildrenFormat",InvalidSchema:"InvalidSchema",NonexistentEntityParent:"NonexistentEntityParent",MissingEntityAttributes:"MissingEntityAttributes",InvalidEntityAttributesFormat:"InvalidEntityAttributesFormat",UnknownEntityAttributeType:"UnknownEntityAttributeType",InvalidEntityAttributes:"InvalidEntityAttributes",InvalidEntitiesAttributes:"InvalidEntitiesAttributes",SelfEntityReference:"SelfEntityReference",ChildNotAllowed:"ChildNotAllowed",EntityChildrenMismatch:"EntityChildrenMismatch",ParentRequired:"ParentRequired",ParentNotAllowed:"ParentNotAllowed",EntityParentMismatch:"EntityParentMismatch",UnreachableEntity:"UnreachableEntity"},Kt={[B.InvalidRootFormat]:"The root must be an array of strings.",[B.DuplicateRootId]:"Duplicate IDs detected in the root.",[B.DuplicateChildId]:"Duplicate IDs detected in the children.",[B.RootEntityWithParent]:"Root entities can't have a parent.",[B.EmptyRoot]:"The root must contain at least one entity.",[B.NonexistentEntityId]:"A provided entity ID does not exist.",[B.InvalidEntitiesFormat]:"Entities should be an object containing valid entities.",[B.MissingEntityType]:"Entity type is missing.",[B.UnknownEntityType]:"The provided entity type is unknown.",[B.InvalidChildrenFormat]:"The provided children are invalid.",[B.NonexistentEntityParent]:"The parent ID references a non-existent entity.",[B.MissingEntityAttributes]:"Entity attributes are missing.",[B.InvalidEntityAttributesFormat]:"The provided entity attributes are invalid.",[B.UnknownEntityAttributeType]:"The provided entity attribute type is unknown.",[B.SelfEntityReference]:"Self entity reference.",[B.ChildNotAllowed]:"Child is not allowed.",[B.EntityChildrenMismatch]:"Children relationship mismatch.",[B.EntityParentMismatch]:"Parent relationship mismatch.",[B.ParentRequired]:"A parent is required.",[B.ParentNotAllowed]:"Parent is not allowed.",[B.UnreachableEntity]:"The entity is not in the root and has no parent ID.",[B.InvalidEntityAttributes]:"Validation has failed for some entity attributes.",[B.InvalidEntitiesAttributes]:"Validation has failed for some entities attributes.",[B.InvalidSchema]:"Custom schema validation has failed."},b=class extends Error{constructor(r){var i;super((i=Kt[r.code])!=null?i:"Unknown error");this.reason=r}};function Z(t,e){let r=G(t.type,e);if(!r)throw new b({code:B.UnknownEntityType,payload:{entityId:t.id,entityType:t.type}});return r}function jt(t){if(typeof t.type!="string"||t.type.length===0)throw new b({code:B.MissingEntityType,payload:{entityId:t.id}})}function Ft(t){if(typeof t.attributes!="object"||Array.isArray(t.attributes)||t.attributes===null)throw new b({code:B.InvalidEntityAttributesFormat,payload:{entityId:t.id,entityAttributes:t.attributes}})}function qt(t){if(!t.attributes)throw new b({code:B.MissingEntityAttributes,payload:{entityId:t.id}})}function zt(t,e,r){let i=Z(t,r);if(!(i!=null&&i.attributes.some(s=>s.name===e)))throw new b({code:B.UnknownEntityAttributeType,payload:{entityId:t.id,attributeName:e}})}function Ht(t,e){Object.keys(t.attributes).forEach(r=>zt(t,r,e))}async function $t(t,e,r){var p,T,f,w;let i=Z(t,e),s={},c=u({},t.attributes);for(let o of i.attributes)try{let l=t.attributes[o.name],n={schema:r,entity:t},a=h=>o.validate(h,n),d=(p=i.attributesExtensions[o.name])!=null&&p.validate?h=>{var m,I;return(I=(m=i.attributesExtensions[o.name])==null?void 0:m.validate)==null?void 0:I.call(m,h,y(u({},n),{validate:a}))}:void 0,E=(w=(f=(T=e.entitiesExtensions[t.type])==null?void 0:T.attributes)==null?void 0:f[o.name])==null?void 0:w.validate;E?l=await E(l,y(u({},n),{validate:d!=null?d:a})):d?l=await d(l):l=await a(l),c[o.name]=l}catch(l){s[o.name]=l}if(Object.keys(s).length)throw new b({code:B.InvalidEntityAttributes,payload:{entityId:t.id,attributesErrors:s}});return c}function Lt(t,e){if(typeof t.parentId=="undefined")return;let r=e[t.parentId];if(!r)throw new b({code:B.NonexistentEntityParent,payload:{entityId:t.id,entityParentId:t.parentId}});return y(u({},r),{id:t.parentId})}function Gt(t){var e;if(t.parentId===t.id||(e=t.children)!=null&&e.includes(t.id))throw new b({code:B.SelfEntityReference,payload:{entityId:t.id}})}function Jt(t){if(typeof t.children!="undefined"&&!Array.isArray(t.children))throw new b({code:B.InvalidChildrenFormat,payload:{entityId:t.id}})}function Qt(t,e,r){if(!J(t.type,e.type,r))throw new b({code:B.ChildNotAllowed,payload:{entityId:t.id,childId:e.id}})}function Xt(t,e,r){t.children&&t.children.forEach(i=>{let s=V(i,r);Qt(t,s,e)})}function Yt(t,e){if(t.children&&t.children.filter(r=>r===e).length>1)throw new b({code:B.DuplicateChildId,payload:{entityId:t.id}})}function Zt(t,e,r){t.children&&t.children.forEach(i=>{e.validateEntityId(i),V(i,r),Yt(t,i)})}function _t(t,e){if(t.parentId!==e)throw new b({code:B.EntityChildrenMismatch,payload:{entityId:e,childId:t.id}})}function te(t,e){t.children&&t.children.forEach(r=>_t(V(r,e),t.id))}function ee(t,e){var i;if(!t.parentId)return;if(!((i=V(t.parentId,e).children)!=null&&i.includes(t.id)))throw new b({code:B.EntityParentMismatch,payload:{entityId:t.id,parentId:t.parentId}})}function re(t,e){if(!t.parentId&&pt(t.type,e))throw new b({code:B.ParentRequired,payload:{entityId:t.id}})}function ie(t,e,r){if(!t.parentId)return;let i=V(t.parentId,r);if(!Q(t.type,i.type,e))throw new b({code:B.ParentNotAllowed,payload:{entityId:t.id,parentId:t.parentId}})}function ne(t,e){if(!t.parentId&&!e.includes(t.id))throw new b({code:B.UnreachableEntity,payload:{entityId:t.id}})}function se(t,e,r){return e.validateEntityId(t.id),typeof t.parentId!="undefined"&&e.validateEntityId(t.parentId),jt(t),Z(t,e),qt(t),Ft(t),Ht(t,e),Lt(t,r.entities),Gt(t),Jt(t),Zt(t,e,r.entities),Xt(t,e,r.entities),te(t,r.entities),ee(t,r.entities),re(t,e),ie(t,e,r.entities),ne(t,r.root),u(u({type:t.type,attributes:t.attributes},t.parentId?{parentId:t.parentId}:{}),t.children?{children:t.children}:{})}function V(t,e){let r=e[t];if(!r)throw new b({code:B.NonexistentEntityId,payload:{entityId:t}});return y(u({},r),{id:t})}function ae(t,e){if(e.filter(r=>r===t).length>1)throw new b({code:B.DuplicateRootId,payload:{entityId:t}})}function oe(t){if(typeof t!="object"||Array.isArray(t)||t===null)throw new b({code:B.InvalidEntitiesFormat,payload:{entities:t}})}function de(t){if(!Array.isArray(t))throw new b({code:B.InvalidRootFormat,payload:{root:t}})}function le(t){if(t.root.length===0&&Object.keys(t.entities).length>0)throw new b({code:B.EmptyRoot})}function ue(t,e){return Object.entries(t.entities).reduce((r,[i,s])=>y(u({},r),{[i]:se(y(u({},s),{id:i}),e,t)}),t.entities)}function ce(t,e){t.root.forEach(r=>{e.validateEntityId(r),V(r,t.entities),ae(r,t.root)})}function Ee(t,e){if(typeof V(t,e).parentId!="undefined")throw new b({code:B.RootEntityWithParent,payload:{entityId:t}})}function ye(t){t.root.forEach(e=>Ee(e,t.entities))}function pe(){return{entities:{},root:[]}}function j(t,e){let r=t;if(typeof t=="undefined")return{data:pe(),success:!0};try{oe(r.entities),de(r.root),le(r);let s={entities:ue(r,e),root:r.root};return ce(s,e),ye(s),{data:s,success:!0}}catch(i){if(i instanceof b)return{reason:i.reason,success:!1};throw i}}async function he(t,e){let r={},i=u({},t.entities);for(let[s,c]of Object.entries(t.entities))try{let p=await $t(y(u({},c),{id:s}),e,t),T=i[s];if(!T)throw new Error("Entity not found.");T.attributes=p}catch(p){if(p instanceof b&&p.reason.code===B.InvalidEntityAttributes)r[s]=p.reason.payload.attributesErrors;else throw p}return Object.keys(r).length?{success:!1,reason:new b({code:B.InvalidEntitiesAttributes,payload:{entitiesAttributesErrors:r}}).reason}:{success:!0,data:{root:t.root,entities:i}}}async function me(t,e){let r=j(t,e);if(!r.success)return r;let i=await he(r.data,e);if(!i.success)return i;try{return{success:!0,data:await e.validateSchema(i.data)}}catch(s){return{success:!1,reason:new b({code:B.InvalidSchema,payload:{schemaError:s}}).reason}}}function N(t,e,r){let i=new Set(t);i.delete(e);let s=Array.from(i);return s.splice(r!=null?r:t.size,0,e),new Set(s)}var S={EntityAdded:"EntityAdded",EntityUpdated:"EntityUpdated",EntityAttributeUpdated:"EntityAttributeUpdated",EntityDeleted:"EntityDeleted",EntityCloned:"EntityCloned",RootUpdated:"RootUpdated",EntityAttributeErrorUpdated:"EntityAttributeErrorUpdated",SchemaErrorUpdated:"SchemaErrorUpdated",SchemaUpdated:"SchemaUpdated",DataSet:"DataSet"};function v(t,e){let r=e.get(t);if(!r)throw new Error(`Entity with ID "${t}" was not found.`);let i=u({},r);return i.children&&(i.children=new Set(i.children)),i}function ft(t,e){var p,T;let r=v(t,e.schema.entities),i=y(u({},e),{schema:y(u({},e.schema),{entities:new Map(e.schema.entities)})});if(i.schema.root.delete(t),r.parentId){let f=v(r.parentId,i.schema.entities);(p=f.children)==null||p.delete(t),i.schema.entities.set(r.parentId,f)}let s=[y(u({},r),{id:t})],c=Array.from((T=r.children)!=null?T:[]).reduce((f,w)=>{let o=ft(w,f.data);return{data:o.data,deletedEntities:f.deletedEntities.concat(o.deletedEntities)}},{data:i,deletedEntities:[]});return s=s.concat(c.deletedEntities),c.data.schema.entities.delete(t),c.data.entitiesAttributesErrors.delete(t),{data:c.data,deletedEntities:s}}async function Bt(t,e,r,i,s){var o,l,n,a,d;let c=v(t,i.schema.entities),p=R(c.type,r),T=K(c.type,e,r),f=new Map(i.entitiesAttributesErrors),w=u({},f.get(t));try{let E=c.attributes[T.name],h=y(u({},A(c)),{id:t}),m={schema:s,entity:h},I=O=>T.validate(O,m),g=(o=p.attributesExtensions[T.name])!=null&&o.validate?O=>{var C,lt;return(lt=(C=p.attributesExtensions[T.name])==null?void 0:C.validate)==null?void 0:lt.call(C,O,y(u({},m),{validate:I}))}:void 0,P=(a=(n=(l=r.entitiesExtensions[c.type])==null?void 0:l.attributes)==null?void 0:n[T.name])==null?void 0:a.validate;P?await P(E,y(u({},m),{validate:g!=null?g:I})):g?await g(E):await I(E),w==null||delete w[e],f.set(t,w)}catch(E){f.set(t,y(u({},w),{[e]:E}))}return Object.keys((d=f.get(t))!=null?d:{}).length===0&&f.delete(t),f}function U(t){return{name:S.EntityAttributeErrorUpdated,payload:{entity:t.entity,attributeName:t.attributeName,error:t.error}}}async function Tt(t,e,r){var f;let i=new Map(e.entitiesAttributesErrors),s=v(t,e.schema.entities),c=R(s.type,r),p=[],T=D(e.schema);for(let w of c.attributes)i=await Bt(t,w.name,r,y(u({},e),{entitiesAttributesErrors:i}),T),p.push(U({entity:y(u({},A(s)),{id:t}),attributeName:w.name,error:(f=i.get(t))==null?void 0:f[w.name]}));return{entityAttributesErrors:i.get(t),events:p}}async function mt(t,e){let r=new Map(t.entitiesAttributesErrors),i=[];for(let s of Array.from(t.schema.entities.keys())){let{entityAttributesErrors:c,events:p}=await Tt(s,t,e);c?r.set(s,c):r.delete(s),i=i.concat(p)}return{entitiesAttributesErrors:r,events:i}}function fe(t,e,r){if(typeof t!="object"||Array.isArray(t)||t===null)throw new Error("Invalid errors format.");let i=u({},t);for(let[s,c]of Object.entries(t)){let p=e[s];if(!p)throw new Error("Entity not found.");F(p.type,Object.keys(c),r),i[s]=c}return i}function M(t){return Array.from(t)}function D(t){let e={};for(let[r,i]of t.entities)e[r]=A(i);return{root:M(t.root),entities:e}}function et(t){return Object.fromEntries(t)}function _(t){return{schema:D(t.schema),entitiesAttributesErrors:et(t.entitiesAttributesErrors),schemaError:t.schemaError}}function A(t){return y(u(u({},t),t.children?{children:Array.from(t.children)}:{}),{attributes:t.attributes})}function Be(t){return new Map(Object.entries(t))}function Te(t){return{entities:new Map(Object.entries(t.entities).map(([e,r])=>[e,y(u(u({},r),r.children?{children:new Set(r.children)}:{}),{attributes:r.attributes})])),root:new Set(t.root)}}function be(t){return{schema:Te(t.schema),entitiesAttributesErrors:Be(t.entitiesAttributesErrors),schemaError:t.schemaError}}function tt(t,e){let r=j(t.schema,e);if(!r.success)throw new b(r.reason);let i=fe(t.entitiesAttributesErrors,r.data.entities,e);return be({schema:r.data,entitiesAttributesErrors:i,schemaError:t.schemaError})}function Se(t,e){var i,s;let r=v(t,e.entities);if(r.parentId){let c=v(r.parentId,e.entities);return Array.from((i=c.children)!=null?i:[t]).indexOf(t)}return Array.from((s=e.root)!=null?s:[t]).indexOf(t)}function bt(t,e,r,i,s){var o;let{schema:c,entity:p}=St(y(u({},e),{index:s==null?void 0:s.index}),r,i),T=[],f=u({},c);if(e.children){p.children=new Set;for(let l of(o=e.children)==null?void 0:o.values()){let n=v(l,r.entities),a=bt(l,y(u({},n),{parentId:p.id}),f,i,{index:s.index,isCloneOrigin:!1});f=a.schema,p.children.add(a.entityClone.id),T=T.concat(a.events)}}let w=y(u({},A(e)),{id:t});return T.unshift({name:S.EntityCloned,payload:{entity:w,entityClone:y(u({},A(p)),{id:p.id}),isCloneOrigin:s.isCloneOrigin}}),{schema:f,entityClone:p,events:T}}function St(t,e,r){var T;let i=r.generateEntityId();if(r.validateEntityId(i),e.entities.has(i))throw new Error(`An entitiy with the ID "${i}" already exists.`);let s={attributes:t.attributes,type:t.type,parentId:t==null?void 0:t.parentId};F(s.type,Object.keys(s.attributes),r),s.parentId||delete s.parentId;let c=new Map(e.entities),p=new Set(e.root);if(c.set(i,s),!(t!=null&&t.parentId))p=N(p,i,t==null?void 0:t.index),Y(s.type,r);else{let f=v(t.parentId,e.entities);q(f.type,s.type,r),X(s.type,f.type,r),f.children=N((T=f.children)!=null?T:new Set,i,t==null?void 0:t.index),c.set(t.parentId,f)}return{schema:{entities:c,root:p},entity:y(u({},s),{id:i})}}function It(t,e,r){let i=v(e,r);if(!i.parentId)return!1;if(t===i.parentId)throw new Error("Target entity is a direct child.");return It(t,i.parentId,r)}function Ie(t,e){var c,p,T,f,w;let{getData:r,setData:i,subscribe:s}=z(tt({schema:(p=(c=e==null?void 0:e.initialData)==null?void 0:c.schema)!=null?p:{entities:{},root:[]},entitiesAttributesErrors:(f=(T=e==null?void 0:e.initialData)==null?void 0:T.entitiesAttributesErrors)!=null?f:{},schemaError:(w=e==null?void 0:e.initialData)==null?void 0:w.schemaError},t));return{builder:t,subscribe(o){return s((l,n)=>o(_(l),n))},getData(){return _(r())},setData(o){let l=tt(o,t);i(l,[{name:S.DataSet,payload:{data:_(l)}}])},addEntity(o){let l=r(),{schema:n,entity:a}=St(o,l.schema,t),d=[{name:S.EntityAdded,payload:{entity:y(u({},A(a)),{id:a.id})}}];if(!o.parentId)d.push({name:S.RootUpdated,payload:{root:M(n.root)}});else{let E=v(o.parentId,n.entities);d.push({name:S.EntityUpdated,payload:{entity:y(u({},A(E)),{id:o.parentId})}})}return d.push({name:S.SchemaUpdated,payload:{schema:D(n)}}),i(y(u({},l),{schema:n}),d),y(u({},A(a)),{id:a.id})},setEntityParent(o,l,n){var P,O;let a=r(),d=new Map(a.schema.entities),E=new Set(a.schema.root),h=v(o,a.schema.entities);if(!h.parentId&&a.schema.root.size===1)throw new Error("The root must contain at least one entity.");let m=v(l,a.schema.entities);X(h.type,m.type,t),It(o,l,a.schema.entities);let I=[];if(h.parentId){let C=v(h.parentId,a.schema.entities);(P=C.children)==null||P.delete(o),d.set(h.parentId,C),h.parentId!==l&&I.push({name:S.EntityUpdated,payload:{entity:y(u({},A(C)),{id:h.parentId})}})}else E.delete(o),I.push({name:S.RootUpdated,payload:{root:M(E)}});h.parentId=l,d.set(o,h),I.push({name:S.EntityUpdated,payload:{entity:y(u({},A(h)),{id:o})}}),q(m.type,h.type,t),m.children=N((O=m.children)!=null?O:new Set,o,n==null?void 0:n.index),d.set(l,m),I.push({name:S.EntityUpdated,payload:{entity:y(u({},A(m)),{id:l})}});let g={entities:d,root:E};I.push({name:S.SchemaUpdated,payload:{schema:D(g)}}),i(y(u({},a),{schema:{entities:d,root:E}}),I)},unsetEntityParent(o,l){var I;let n=r(),a=new Map(n.schema.entities),d=new Set(n.schema.root),E=v(o,n.schema.entities),h=[];if(Y(E.type,t),E.parentId){let g=v(E.parentId,n.schema.entities);(I=g.children)==null||I.delete(o),a.set(E.parentId,g),h.push({name:S.EntityUpdated,payload:{entity:y(u({},A(g)),{id:E.parentId})}})}d.delete(o),h.push({name:S.RootUpdated,payload:{root:M(d)}}),delete E.parentId,a.set(o,E),h.push({name:S.EntityUpdated,payload:{entity:y(u({},A(E)),{id:o})}});let m={entities:a,root:N(d,o,l==null?void 0:l.index)};h.push({name:S.SchemaUpdated,payload:{schema:D(m)}}),i(y(u({},n),{schema:m}),h)},deleteEntity(o){let{data:l,deletedEntities:n}=ft(o,r()),a=n.reduce((d,E)=>{if(d.push({name:S.EntityDeleted,payload:{entity:y(u({},A(E)),{id:E.id})}}),!E.parentId)d.push({name:S.RootUpdated,payload:{root:M(l.schema.root)}});else if(E.parentId&&!n.some(h=>h.id===E.parentId)){let h=v(E.parentId,l.schema.entities);d.push({name:S.EntityUpdated,payload:{entity:y(u({},A(h)),{id:E.parentId})}})}return d},[]);a.push({name:S.SchemaUpdated,payload:{schema:D(l.schema)}}),i(l,a)},setEntityAttribute(o,l,n){let a=r(),d=v(o,a.schema.entities);K(d.type,l.toString(),t),d.attributes=y(u({},d.attributes),{[l]:n});let E={root:a.schema.root,entities:a.schema.entities.set(o,d)};i(y(u({},a),{schema:E}),[{name:S.EntityUpdated,payload:{entity:y(u({},A(d)),{id:o})}},{name:S.EntityAttributeUpdated,payload:{entity:y(u({},A(d)),{id:o}),attributeName:l}},{name:S.SchemaUpdated,payload:{schema:D(E)}}])},setEntityIndex(o,l){var h,m;let n=r(),a=v(o,n.schema.entities);if(a.parentId){let I=new Map(n.schema.entities),g=v(a.parentId,n.schema.entities);q(g.type,a.type,t),(h=g.children)==null||h.delete(o),g.children=N((m=g.children)!=null?m:new Set,o,l),I.set(a.parentId,g);let P=y(u({},n.schema),{entities:I});i(y(u({},n),{schema:P}),[{name:S.EntityUpdated,payload:{entity:y(u({},A(g)),{id:a.parentId})}},{name:S.SchemaUpdated,payload:{schema:D(P)}}]);return}let d=new Set(n.schema.root);d.delete(o);let E=y(u({},n.schema),{root:N(d,o,l)});i(y(u({},n),{schema:E}),[{name:S.RootUpdated,payload:{root:M(d)}},{name:S.SchemaUpdated,payload:{schema:D(E)}}])},async validateEntityAttribute(o,l){var E;let n=r(),a=await Bt(o,l,t,n,D(n.schema)),d=v(o,n.schema.entities);i(y(u({},n),{entitiesAttributesErrors:a}),[U({entity:y(u({},A(d)),{id:o}),attributeName:l,error:(E=a.get(o))==null?void 0:E[l]})])},async validateEntityAttributes(o){let l=r(),{entityAttributesErrors:n,events:a}=await Tt(o,l,t),d=new Map(l.entitiesAttributesErrors);d.set(o,n!=null?n:{}),i(y(u({},l),{entitiesAttributesErrors:d}),a)},async validateEntitiesAttributes(){let o=r(),{events:l,entitiesAttributesErrors:n}=await mt(o,t);i(y(u({},o),{entitiesAttributesErrors:n}),l)},resetEntityAttributeError(o,l){let n=r(),a=new Map(n.entitiesAttributesErrors),d=v(o,n.schema.entities);K(d.type,l.toString(),t);let E=n.entitiesAttributesErrors.get(o);E==null||delete E[l],E&&Object.keys(E).length?a.set(o,E):a.delete(o),i(y(u({},n),{entitiesAttributesErrors:a}),[U({entity:y(u({},A(d)),{id:o}),attributeName:l,error:void 0})])},setEntityAttributeError(o,l,n){let a=r(),d=new Map(a.entitiesAttributesErrors),E=v(o,a.schema.entities);K(E.type,l.toString(),t),d.set(o,y(u({},a.entitiesAttributesErrors.get(o)),{[l]:n})),i(y(u({},a),{entitiesAttributesErrors:d}),[U({entity:y(u({},A(E)),{id:o}),attributeName:l,error:n})])},resetEntityAttributesErrors(o){var E;let l=r(),n=new Map(l.entitiesAttributesErrors),a=v(o,l.schema.entities),d=[];for(let h of Object.keys((E=n.get(o))!=null?E:{}))d.push(U({entity:y(u({},A(a)),{id:o}),attributeName:h,error:void 0}));n.delete(o),i(y(u({},l),{entitiesAttributesErrors:n}),d)},setEntityAttributesErrors(o,l){let n=r(),a=new Map(n.entitiesAttributesErrors),d=n.entitiesAttributesErrors.get(o),E=v(o,n.schema.entities);F(E.type,Object.keys(l),t),a.set(o,l);let h=[];for(let m of Object.keys(d!=null?d:{}))l[m]||h.push(U({entity:y(u({},A(E)),{id:o}),attributeName:m,error:void 0}));for(let[m,I]of Object.entries(l))h.push(U({entity:y(u({},A(E)),{id:o}),attributeName:m,error:I}));i(y(u({},n),{entitiesAttributesErrors:a}),h)},resetEntitiesAttributesErrors(){let o=r(),l=[];for(let[n,a]of o.entitiesAttributesErrors)for(let d of Object.keys(a))l.push(U({entity:y(u({},A(v(n,o.schema.entities))),{id:n}),attributeName:d,error:void 0}));i(y(u({},o),{entitiesAttributesErrors:new Map}),l)},setEntitiesAttributesErrors(o){let l=r(),n=tt({schema:D(l.schema),entitiesAttributesErrors:o,schemaError:l.schemaError},t),a=[];for(let[d,E]of l.entitiesAttributesErrors){let h=n.entitiesAttributesErrors.get(d),m=v(d,l.schema.entities);for(let I of Object.keys(E))h!=null&&h[I]||a.push(U({entity:y(u({},A(m)),{id:d}),attributeName:I,error:void 0}))}for(let[d,E]of n.entitiesAttributesErrors){let h=v(d,l.schema.entities);for(let m of Object.keys(E))a.push(U({entity:y(u({},A(h)),{id:d}),attributeName:m,error:E[m]}))}i(n,a)},cloneEntity(o){let l=r(),n=v(o,l.schema.entities),{schema:a,events:d}=bt(o,n,l.schema,t,{index:Se(o,l.schema)+1,isCloneOrigin:!0});n.parentId?d.push({name:"EntityUpdated",payload:{entity:y(u({},A(v(n.parentId,a.entities))),{id:n.parentId})}}):d.push({name:"RootUpdated",payload:{root:M(a.root)}}),d.push({name:S.SchemaUpdated,payload:{schema:D(a)}}),i(y(u({},l),{schema:a}),d)},async validateSchema(){let o=r(),l=[],{events:n,entitiesAttributesErrors:a}=await mt(o,t);if(l=l.concat(n),a.size)return i(y(u({},o),{entitiesAttributesErrors:a}),l),{success:!1,reason:{code:B.InvalidEntitiesAttributes,payload:{entitiesAttributesErrors:et(a)}}};let d;try{await t.validateSchema(D(o.schema)),l.push({name:S.SchemaErrorUpdated,payload:{error:void 0}})}catch(E){d=E,l.push({name:S.SchemaErrorUpdated,payload:{error:E}})}return i(y(u({},o),{entitiesAttributesErrors:a,schemaError:d}),l),d?{success:!1,reason:{code:B.InvalidSchema,payload:{schemaError:d}}}:{success:!0,data:D(o.schema)}},setSchemaError(o){i(y(u({},r()),{schemaError:o}),[{name:S.SchemaErrorUpdated,payload:{error:o}}])},resetSchemaError(){i(y(u({},r()),{schemaError:void 0}),[{name:S.SchemaErrorUpdated,payload:{error:void 0}}])},getSchema(){return D(r().schema)},getEntitiesAttributesErrors(){return et(r().entitiesAttributesErrors)},getSchemaError(){return r().schemaError},getEntity(o){let l=r().schema.entities.get(o);return l?y(u({},A(l)),{id:o}):null}}}async function H(t,e,r,i){let s=V(t,i.entities),c=R(s.type,r);try{return{success:!0,value:await c.validate(e[t],{entity:s,entitiesValues:e})}}catch(p){return{success:!1,error:p}}}function At(t,e,r,i){let s=V(t,r.entities),c=R(s.type,i),p=c.shouldBeProcessed({entity:s,entitiesValues:e}),T=[];if(c.valueAllowed&&p&&T.push(t),s.children&&p)for(let f of s.children)T=T.concat(At(f,e,r,i));return T}function $(t,e,r){let i=[];for(let s of r.root)i=i.concat(At(s,t,r,e));return i}async function Ae(t,e,r){let i=typeof t!="object"||Array.isArray(t)||t===null?{}:t,s=$(i,e,r),c={},p=u({},i);for(let T in p)s.includes(T)||delete p[T];for(let T of s){let f=await H(T,p,e,r);f.success?p[T]=f.value:c[T]=f.error}return Object.keys(c).length?{success:!1,entitiesErrors:c}:{success:!0,data:p}}var x={EntityValueUpdated:"EntityValueUpdated",EntityErrorUpdated:"EntityErrorUpdated",EntityUnprocessable:"EntityUnprocessable",EntityProcessable:"EntityProcessable",DataSet:"DataSet"};function ve(t,e){if(typeof t!="object"||Array.isArray(t)||t===null)throw new Error("Invalid errors format.");for(let r of Object.keys(t))if(!e.entities[r])throw new Error("Entity not found.");return t}function we(t,e){if(typeof t!="object"||Array.isArray(t)||t===null)throw new Error("Invalid values format.");for(let r of Object.keys(t))if(!e.entities[r])throw new Error("Entity not found.");return t}function xe(t){return{entitiesValues:new Map(Object.entries(t.entitiesValues)),entitiesErrors:new Map(Object.entries(t.entitiesErrors)),unprocessableEntitiesIds:new Set}}function k(t){return Object.fromEntries(t)}function at(t){return Object.fromEntries(t)}function xt(t){return Array.from(t)}function rt(t){return{entitiesValues:k(t.entitiesValues),entitiesErrors:at(t.entitiesErrors),unprocessableEntitiesIds:xt(t.unprocessableEntitiesIds)}}function it(t,e){let r=we(t.entitiesValues,e),i=ve(t.entitiesErrors,e);return xe({entitiesValues:r,entitiesErrors:i,unprocessableEntitiesIds:[]})}function gt(t,e,r,i){let s=new Map(e),c=V(t,r.entities),T=R(c.type,i).defaultValue({entity:c,entitiesValues:k(e)});return s.set(t,T),s}function vt(t,e,r,i){let s=new Map(t);for(let c of Object.keys(e.entities))!dt(c,r,e)||i!=null&&i.skipAlreadySetEntitiesValues&&t.has(c)||(s=gt(c,s,e,r));return s}function dt(t,e,r){let i=V(t,r.entities);return R(i.type,e).valueAllowed}function L(t,e,r){if(!dt(t,e,r))throw new Error("Entity value not allowed.")}function ot(t,e,r){if(!dt(t,e,r))throw new Error("Entity error not allowed.")}function wt(t,e,r){for(let i of t.keys())L(i,e,r)}function nt(t,e,r){for(let i of t.keys())ot(i,e,r)}function Vt(t,e){let r=V(t,e.entities),i=[];if(r.children)for(let s of r.children)i.push(s),i=i.concat(Vt(s,e));return i}function Dt(t,e,r,i){let s=new Set(r.unprocessableEntitiesIds),c=new Map(r.entitiesValues),T=R(t.type,i).shouldBeProcessed({entitiesValues:k(c),entity:t}),f=[];if(!T)return s.has(t.id)?{data:r,events:f}:(f.push({name:x.EntityUnprocessable,payload:{entityId:t.id}}),f.push({name:x.EntityValueUpdated,payload:{entityId:t.id,value:void 0}}),c.delete(t.id),s.add(t.id),Vt(t.id,e).forEach(o=>{s.add(o),c.delete(o),f.push({name:x.EntityUnprocessable,payload:{entityId:o}}),f.push({name:x.EntityValueUpdated,payload:{entityId:o,value:void 0}})}),{data:y(u({},r),{entitiesValues:c,unprocessableEntitiesIds:s}),events:f});if(s.has(t.id)&&(s.delete(t.id),f.push({name:x.EntityProcessable,payload:{entityId:t.id}})),t.children)for(let w of t.children){let o=V(w,e.entities),l=Dt(o,e,y(u({},r),{entitiesValues:c,unprocessableEntitiesIds:s}),i);f=f.concat(l.events),s=l.data.unprocessableEntitiesIds,c=l.data.entitiesValues}return{data:y(u({},r),{entitiesValues:c,unprocessableEntitiesIds:s}),events:f}}function W(t,e,r){let i=new Set(e.unprocessableEntitiesIds),s=new Map(e.entitiesValues),c=[];for(let p of t.root){let T=V(p,t.entities),f=Dt(T,t,y(u({},e),{entitiesValues:s,unprocessableEntitiesIds:i}),r);i=f.data.unprocessableEntitiesIds,s=f.data.entitiesValues,c=c.concat(f.events)}return{data:y(u({},e),{entitiesValues:s,unprocessableEntitiesIds:i}),events:c}}function Rt(t,e){return!e.unprocessableEntitiesIds.has(t)}function st(t,e){if(!Rt(t,e))throw new Error("Entity not processable.")}function ge(t,e,r){var f,w,o,l;let i=j(e,t);if(!i.success)throw new b(i.reason);let s=it({entitiesValues:(w=(f=r==null?void 0:r.initialData)==null?void 0:f.entitiesValues)!=null?w:{},entitiesErrors:(l=(o=r==null?void 0:r.initialData)==null?void 0:o.entitiesErrors)!=null?l:{}},i.data);wt(s.entitiesValues,t,e),nt(s.entitiesErrors,t,e),(r==null?void 0:r.initialEntitiesValuesWithDefaults)!==!1&&(s.entitiesValues=vt(s.entitiesValues,e,t,{skipAlreadySetEntitiesValues:!0})),s=W(e,s,t).data;let{getData:c,setData:p,subscribe:T}=z(s);return{builder:t,schema:e,subscribe(n){return T((a,d)=>n(rt(a),d))},getData(){return rt(c())},setData(n){let a=it(n,i.data);wt(a.entitiesValues,t,e),nt(a.entitiesErrors,t,e),a.unprocessableEntitiesIds=c().unprocessableEntitiesIds;let d=W(e,a,t);a=d.data;let E=[{name:x.DataSet,payload:{data:rt(a)}}];p(a,E.concat(d.events))},setEntityValue(n,a){L(n,t,e);let d=c();st(n,d);let E=new Map(d.entitiesValues);E.set(n,a);let h=y(u({},d),{entitiesValues:E}),m=W(e,h,t);h=m.data;let I=[{name:x.EntityValueUpdated,payload:{entityId:n,value:a}}];p(h,I.concat(m.events))},resetEntityValue(n){L(n,t,e);let a=c();st(n,a);let d=gt(n,a.entitiesValues,e,t),E=y(u({},a),{entitiesValues:d}),h=W(e,E,t);E=h.data;let m=[{name:x.EntityValueUpdated,payload:{entityId:n,value:d.get(n)}}];p(E,m.concat(h.events))},resetEntitiesValues(){let n=c(),a=vt(n.entitiesValues,e,t),d=[];for(let m of a.keys())d.push({name:x.EntityValueUpdated,payload:{entityId:m,value:a.get(m)}});let E=y(u({},n),{entitiesValues:a}),h=W(e,E,t);E=h.data,p(E,d.concat(h.events))},clearEntityValue(n){L(n,t,e);let a=c();st(n,a);let d=new Map(a.entitiesValues);d.delete(n);let E=[{name:x.EntityValueUpdated,payload:{entityId:n,value:void 0}}],h=y(u({},a),{entitiesValues:d}),m=W(e,h,t);h=m.data,p(h,E.concat(m.events))},clearEntitiesValues(){let n=c(),a=[];for(let h of n.entitiesValues.keys())a.push({name:x.EntityValueUpdated,payload:{entityId:h,value:void 0}});let d=y(u({},n),{entitiesValues:new Map}),E=W(e,d,t);d=E.data,p(d,a.concat(E.events))},setEntityError(n,a){ot(n,t,e);let d=c(),E=new Map(d.entitiesErrors);E.set(n,a),p(y(u({},d),{entitiesErrors:E}),[{name:x.EntityErrorUpdated,payload:{entityId:n,error:a}}])},resetEntityError(n){ot(n,t,e);let a=c(),d=new Map(a.entitiesErrors);d.delete(n),p(y(u({},a),{entitiesErrors:d}),[{name:x.EntityErrorUpdated,payload:{entityId:n,error:void 0}}])},resetEntitiesErrors(){let n=c(),a=[];for(let d of n.entitiesErrors.keys())a.push({name:x.EntityErrorUpdated,payload:{entityId:d,error:void 0}});p(y(u({},n),{entitiesErrors:new Map}),a)},setEntitiesErrors(n){let a=c(),d=it({entitiesValues:k(a.entitiesValues),entitiesErrors:n},i.data);nt(d.entitiesErrors,t,e);let E=[];for(let[h]of a.entitiesErrors)d.entitiesErrors.get(h)||E.push({name:x.EntityErrorUpdated,payload:{entityId:h,error:void 0}});for(let[h,m]of d.entitiesErrors)E.push({name:x.EntityErrorUpdated,payload:{entityId:h,error:m}});p(d,E)},async validateEntityValue(n){let a=c(),d=k(a.entitiesValues);if(!$(d,t,e).includes(n))throw new Error("Entity not eligible for validation.");let h=await H(n,d,t,e),m=new Map(a.entitiesErrors);h.success?(m.delete(n),p(y(u({},a),{entitiesErrors:m}),[{name:x.EntityErrorUpdated,payload:{entityId:n,error:void 0}}])):(m.set(n,h.error),p(y(u({},a),{entitiesErrors:m}),[{name:x.EntityErrorUpdated,payload:{entityId:n,error:h.error}}]))},async validateEntitiesValues(){let n=c(),a=new Map(n.entitiesErrors),d=[],E=k(n.entitiesValues),h=$(E,t,e);for(let m of Object.keys(e.entities)){if(!h.includes(m)){a.delete(m),d.push({name:x.EntityErrorUpdated,payload:{entityId:m,error:void 0}});continue}let I=await H(m,E,t,e);I.success?(a.delete(m),d.push({name:x.EntityErrorUpdated,payload:{entityId:m,error:void 0}})):(a.set(m,I.error),d.push({name:x.EntityErrorUpdated,payload:{entityId:m,error:I.error}}))}return p(y(u({},n),{entitiesErrors:a}),d),a.size?{success:!1,entitiesErrors:at(a)}:{success:!0,data:k(n.entitiesValues)}},getEntitiesErrors(){return at(c().entitiesErrors)},getEntitiesValues(){return k(c().entitiesValues)},getUnprocessableEntitiesIds(){return xt(c().unprocessableEntitiesIds)},isEntityProcessable(n){return Rt(n,c())},getEntityValue(n){return c().entitiesValues.get(n)},getEntityError(n){return c().entitiesErrors.get(n)}}}export{b as SchemaValidationError,S as builderStoreEventsNames,Ot as createAttribute,Mt as createBuilder,Ie as createBuilderStore,Wt as createEntity,ge as createInterpreterStore,x as interpreterStoreEventsNames,B as schemaValidationErrorCodes,Ae as validateEntitiesValues,me as validateSchema,j as validateSchemaShape};
